# 自动化发布工作流
# 当创建新的 release tag 时自动发布到 npm
name: Release

on:
  push:
    tags:
      - 'v*'  # 匹配 v1.0.0, v2.1.3 等版本标签

jobs:
  # 发布到 npm
  publish:
    runs-on: ubuntu-latest
    
    steps:
    # 检出代码
    - name: 检出代码
      uses: actions/checkout@v4
    
    # 设置 Node.js 环境
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
        cache: 'pnpm'
    
    # 安装 pnpm
    - name: 安装 pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
    
    # 安装依赖
    - name: 安装依赖
      run: pnpm install --frozen-lockfile
    
    # 运行测试确保代码质量
    - name: 运行测试
      run: pnpm run test
    
    # 构建项目
    - name: 构建项目
      run: pnpm run build
    
    # 发布到 npm
    - name: 发布到 npm
      run: npm publish
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    # 创建 GitHub Release
    - name: 创建 GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## 🚀 新版本发布
          
          ### 📦 安装方式
          ```bash
          npm install saokit@${{ github.ref_name }}
          ```
          
          ### 📋 更新内容
          请查看 [CHANGELOG.md](https://github.com/GoetheDady/saokit/blob/main/CHANGELOG.md) 了解详细更新内容。
          
          ### 🔗 相关链接
          - [npm 包地址](https://www.npmjs.com/package/saokit)
          - [文档地址](https://github.com/GoetheDady/saokit#readme)
        draft: false
        prerelease: false